程序设置4K缓存进行I/O操作时，操作系统处理写入磁盘的行为涉及多个层次和机制。以下是详细说明：

1. **文件系统缓存**：
    - 当程序请求写入数据时，操作系统首先将数据写入文件系统的缓存（page cache）。文件系统缓存通常以页为单位（通常为4K）管理数据。
    - 如果写入的数据小于4K，操作系统会将数据暂存在缓存中，并标记为"脏页"（dirty page），表示这些数据需要写回磁盘。

2. **延迟写（Delayed Write）**：
    - 操作系统不会立即将每个写入请求直接写入磁盘，而是通过延迟写机制批量处理写操作。这种机制可以提高I/O性能，减少频繁的小块写入带来的开销。
    - 当文件系统缓存中的脏页达到一定数量，或者经过了一段时间（写入时间超过阈值），操作系统会将这些脏页批量写入磁盘。

3. **写入磁盘**：
    - 在实际将数据写入磁盘时，操作系统会将缓存中的脏页按页的单位（通常为4K）写入磁盘。
    - 如果写入的数据不满4K，操作系统会将该页的剩余部分用零填充（zero-padding），确保每次写入都是以页（4K）为单位。这种填充保证了磁盘上数据的对齐性和一致性。

4. **文件系统和硬盘的处理**：
    - 硬盘的写入操作也以块（通常为4K）为单位，即使是高级格式的硬盘（Advanced Format），其最小写入单位也是4K。
    - 文件系统可能会进一步对写操作进行优化，比如合并连续的写请求（write coalescing），以减少磁盘寻道时间和提高写入效率。

**示例流程**：

- 程序请求写入2K数据。
- 操作系统将这2K数据写入文件系统缓存中的一个4K页，并标记该页为脏页。
- 在延迟写策略下，当缓存达到一定条件时，操作系统会将这个4K页（包含2K有效数据和2K填充数据）写入磁盘。

**总结**：

当程序进行I/O操作时，操作系统在写入数据到磁盘时通常以4K为单位进行写入。如果写入数据不满4K，操作系统会使用填充数据来保证每次写入的对齐和一致性。这种机制有助于优化磁盘I/O性能和提高系统的整体效率。